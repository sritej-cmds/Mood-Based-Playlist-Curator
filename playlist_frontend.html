<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Playlist AI ü§ñ</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0d0c1d;
      --bg2:#1a1b41;
      --accent:#c084fc;
      --violet:#9333ea;
      --glass: rgba(255,255,255,0.06);
      --muted:#aaa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Poppins","Segoe UI",sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),#4b367c);
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
    }
    header{text-align:center;margin-top:38px;}
    header h1{font-size:2.4rem;color:var(--accent);margin:0;}
    header p{color:var(--muted);margin-top:6px;margin-bottom:18px;}
    #controls{display:flex;gap:10px;width:90%;max-width:920px;margin:8px 0 6px 0;}
    #query{
      flex:1;padding:12px 14px;border-radius:12px;border:none;
      background:rgba(255,255,255,0.08);color:#fff;font-size:1rem;outline:none;
    }
    #generateBtn,#historyBtn{
      border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;
    }
    #generateBtn{background:var(--violet);color:white;}
    #generateBtn:hover{background:#a855f7;}
    #historyBtn{background:#22c55e;color:white;}
    #historyBtn:hover{background:#16a34a;}
    #loadingContainer{
      width:90%;max-width:920px;margin-top:12px;display:none;
      background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;height:8px;
    }
    #loadingBar{
      height:8px;width:0%;
      background:linear-gradient(90deg,#a855f7,#22c55e);
      transition:width 220ms linear;
    }
    #context{
      width:90%;max-width:920px;margin-top:18px;
      background:rgba(255,255,255,0.04);border-radius:14px;
      padding:14px 18px;box-shadow:0 6px 30px rgba(0,0,0,0.35);
      backdrop-filter:blur(8px);
    }
    #contextNote{margin:0;color:var(--accent);font-size:1.05rem;}
    #reflection{
      margin-top:8px;color:#e6e6ee;opacity:0;transform:translateY(6px);
      transition:opacity 420ms ease,transform 420ms ease;line-height:1.5;
    }
    #reflection.show{opacity:1;transform:translateY(0);}
    #main{
      width:90%;max-width:920px;margin-top:20px;
      display:grid;grid-template-columns:1fr 320px;gap:18px;
    }
    #playlistCard{
      background:rgba(255,255,255,0.03);
      padding:14px;border-radius:14px;
    }
    #playlistHeader{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;
    }
    #playlistHeader .rightButtons{display:flex;gap:8px;}
    #playlistTitle{color:var(--accent);margin:0;font-size:1.1rem;}
    #deletePlaylistBtn,#addSuggestedBtn{
      border:none;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600;
    }
    #deletePlaylistBtn{background:#ef4444;color:white;}
    #deletePlaylistBtn:hover{background:#dc2626;}
    #addSuggestedBtn{background:#3b82f6;color:white;}
    #addSuggestedBtn:hover{background:#2563eb;}
    #songList{list-style:none;padding:0;margin:0;}
    .songRow{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:10px;margin-bottom:10px;border-radius:10px;
      background:rgba(255,255,255,0.02);
      transition:transform 180ms ease,background 180ms ease;
    }
    .songRow:hover{transform:translateY(-3px);background:rgba(147,51,234,0.06);}
    .songInfo{flex:1;font-size:0.98rem;color:#f3f3f8;}
    .songInfo small{display:block;color:var(--muted);font-size:0.82rem;margin-top:6px;}
    .actions{display:flex;gap:8px;align-items:center;}
    .btnOpen{background:#22c55e;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
    .btnDelete{background:#ef4444;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
    .btnOpen:hover{background:#16a34a;}
    .btnDelete:hover{background:#dc2626;}
    #sideCard{
      background:rgba(255,255,255,0.03);
      padding:14px;border-radius:14px;height:fit-content;
    }
    #historyHeader{color:var(--accent);margin:0 0 8px 0;font-weight:600;}
    #historyList{list-style:none;padding:0;margin:0;max-height:560px;overflow:auto;}
    .historyItem{
      padding:8px;margin-bottom:8px;border-radius:10px;background:rgba(255,255,255,0.02);
      cursor:pointer;transition:background 160ms ease;
    }
    .historyItem:hover{background:rgba(147,51,234,0.05);}
    footer{margin-top:38px;margin-bottom:58px;color:var(--muted);}
    @media (max-width:920px){
      #main{grid-template-columns:1fr;}
      #controls{flex-direction:column;gap:8px;}
      #loadingContainer{width:95%;}
    }
  </style>
</head>
<body>
  <header>
    <h1>Playlist AI</h1>
    <p>vibe-curated by your emotional wingman</p>
  </header>

  <div id="controls">
    <input id="query" placeholder="yo, what‚Äôs the vibe today?" />
    <button id="generateBtn">üé∂ Generate</button>
    <button id="historyBtn">üïò History</button>
  </div>

  <div id="loadingContainer"><div id="loadingBar"></div></div>

  <div id="context">
    <h3 id="contextNote">No playlist yet generate to get started chief</h3>
    <p id="reflection"></p>
  </div>

  <div id="main">
    <div id="playlistCard">
      <div id="playlistHeader">
        <h4 id="playlistTitle">üéß Playlist</h4>
        <div class="rightButtons">
          <button id="addSuggestedBtn">‚ûï Add Suggested Song</button>
          <button id="deletePlaylistBtn">üóëÔ∏è Delete Playlist</button>
        </div>
      </div>
      <ul id="songList"><li style="color:var(--muted)">No playlist loaded.</li></ul>
    </div>

    <aside id="sideCard">
      <h4 id="historyHeader">üïò Playlist History</h4>
      <ul id="historyList"><li style="color:var(--muted)">No history yet.</li></ul>
    </aside>
  </div>

  <footer>made with üíú and caffeine</footer>

<script>
const API_BASE = "http://127.0.0.1:5001";
const queryInput = document.getElementById("query");
const generateBtn = document.getElementById("generateBtn");
const historyBtn = document.getElementById("historyBtn");
const loadingContainer = document.getElementById("loadingContainer");
const loadingBar = document.getElementById("loadingBar");
const contextNote = document.getElementById("contextNote");
const reflectionEl = document.getElementById("reflection");
const songList = document.getElementById("songList");
const historyList = document.getElementById("historyList");
const playlistTitle = document.getElementById("playlistTitle");
const deletePlaylistBtn = document.getElementById("deletePlaylistBtn");
const addSuggestedBtn = document.getElementById("addSuggestedBtn");

let currentPlaylist = null;
let historyData = [];
let loadingInterval = null;

// --- Loading bar ---
function startLoading(){
  loadingContainer.style.display = "block";
  loadingBar.style.width = "0%";
  let w = 0;
  loadingInterval = setInterval(() => {
    w += Math.random()*12;
    if (w > 96) w = 96;
    loadingBar.style.width = w + "%";
  }, 220);
}
function stopLoading(){
  clearInterval(loadingInterval);
  loadingBar.style.width = "100%";
  setTimeout(()=>{loadingContainer.style.display="none";loadingBar.style.width="0%";},420);
}

// --- Render Playlist ---
function sanitizeText(s){ return String(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function renderPlaylist(playlistObj, index=null){
  currentPlaylist = playlistObj;
  contextNote.textContent = playlistObj.context_note || "Playlist";
  reflectionEl.textContent = playlistObj.reflection || "";
  reflectionEl.classList.remove("show"); void reflectionEl.offsetWidth; reflectionEl.classList.add("show");
  playlistTitle.childNodes[0].nodeValue = `üéß Playlist${index ? " #"+index : ""}`;
  const songs = Array.isArray(playlistObj.songs)?playlistObj.songs: (playlistObj.songs && Object.values(playlistObj.songs)) || [];
  if(!songs.length){ songList.innerHTML='<li style="color:var(--muted)">No songs in this playlist.</li>';return; }
  songList.innerHTML="";
  songs.forEach(s=>{
    const name = s.song_name||s.song||s.title||"Unknown";
    const artist = s.artist||"Unknown Artist";
    const url = s.url||s.spotify_url||s.external_url||"#";
    const li=document.createElement("li"); li.className="songRow";
    const info=document.createElement("div");
    info.className="songInfo";
    info.innerHTML=`<strong>${sanitizeText(name)}</strong><small>${sanitizeText(artist)}</small>`;
    const actions=document.createElement("div"); actions.className="actions";
    const openBtn=document.createElement("button");
    openBtn.className="btnOpen"; openBtn.textContent="üéß Open";
    openBtn.addEventListener("click",()=>window.open(url,"_blank"));
    const delBtn=document.createElement("button");
    delBtn.className="btnDelete"; delBtn.textContent="üóë Delete";
    delBtn.addEventListener("click",async()=>{
      if(!currentPlaylist?.id) return alert("No playlist selected.");
      if(!confirm(`Delete "${name}" from playlist?`)) return;
      try{
        const resp=await fetch(`${API_BASE}/playlist/${currentPlaylist.id}/${encodeURIComponent(name)}`,{method:"DELETE"});
        const data=await resp.json();
        alert(data.message||"Deleted");
        if(data.playlist) renderPlaylist(data.playlist);
      }catch(e){alert("Error deleting song");console.error(e);}
    });
    actions.append(openBtn,delBtn);
    li.append(info,actions);
    songList.appendChild(li);
  });
}

// --- Add Suggested Song ---
addSuggestedBtn.addEventListener("click",async()=>{
  if(!currentPlaylist?.id) return alert("No playlist selected!");
  startLoading();
  try{
    const res = await fetch(`${API_BASE}/playlist/${currentPlaylist.id}/similar`);
    const data = await res.json();
    stopLoading();
    if(!data || !data.name){
      alert("No similar song found.");
      return;
    }
    alert(`Added similar song: ${data.name} ‚Äî ${data.artist}`);
    currentPlaylist.songs.push({
      song:data.name,artist:data.artist,url:data.spotify_url
    });
    renderPlaylist(currentPlaylist);
  }catch(e){
    stopLoading();
    console.error(e);
    alert("Error fetching suggested song");
  }
});

// --- Generate playlist ---
async function generatePlaylist(){
  const query=queryInput.value.trim();
  if(!query){alert("Please enter a vibe!");return;}
  startLoading();
  try{
    const res=await fetch(`${API_BASE}/playlist/context`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({query})
    });
    const data=await res.json();
    stopLoading();
    historyData.unshift(data);
    renderHistory();
    renderPlaylist(data,1);
  }catch(e){stopLoading();alert("Network error generating playlist");console.error(e);}
}

// --- History ---
async function fetchHistory(){
  const res=await fetch(`${API_BASE}/playlist`);
  const data=await res.json().catch(()=>[]);
  historyData=(Array.isArray(data)?data:[]).reverse();
  renderHistory();
}
function renderHistory(){
  historyList.innerHTML="";
  if(!historyData.length){historyList.innerHTML='<li style="color:var(--muted)">No history yet.</li>';return;}
  historyData.forEach((p,idx)=>{
    const item=document.createElement("li");
    item.className="historyItem";
    const num=idx+1;
    item.innerHTML=`<strong>Playlist #${num}</strong> ‚Äî ${sanitizeText(p.intent||"")} (${sanitizeText(p.dominant_mood||"")})`;
    item.addEventListener("click",()=>renderPlaylist(p,num));
    historyList.appendChild(item);
  });
}

// --- Delete entire playlist ---
deletePlaylistBtn.addEventListener("click",async()=>{
  if(!currentPlaylist?.id)return alert("No playlist selected.");
  if(!confirm("Delete entire playlist?"))return;
  try{await fetch(`${API_BASE}/playlist/${currentPlaylist.id}`,{method:"DELETE"});}catch(e){console.warn(e);}
  historyData=historyData.filter(h=>h.id!==currentPlaylist.id);
  renderHistory();
  currentPlaylist=null;
  songList.innerHTML='<li style="color:var(--muted)">No playlist loaded.</li>';
  contextNote.textContent='No playlist yet...';
  reflectionEl.textContent='';
  playlistTitle.childNodes[0].nodeValue='üéß Playlist';
});

generateBtn.addEventListener("click",generatePlaylist);
historyBtn.addEventListener("click",fetchHistory);
fetchHistory();
</script>
</body>
</html>
